# 數據更新策略指南

## 📊 數據架構概覽

本專案採用**分離式數據更新策略**，將週期性自動化與歷史數據管理分開處理：

### 🔄 自動化週期更新（美股收盤後執行）
- **腳本**: `etl_lite.py`
- **主要頻率**: 
  - 夏令時間（3月-11月）: 週五 20:05 UTC（美東 16:05 EDT，收盤後 5 分鐘）
  - 標準時間（11月-3月）: 週五 21:05 UTC（美東 16:05 EST，收盤後 5 分鐘）
- **備用頻率**: 週六 6:00 UTC（如主要執行失敗）
- **功能**: 只更新當週數據
- **輸出**: `weekly_stats.json`, `summary.json`
- **執行時間**: < 1 分鐘（包含數據等待）
- **API 調用**: ~10 次

### 🏛️ 歷史數據管理（手動執行）
- **腳本**: `update_historical_data.py`
- **頻率**: 按需手動執行
- **功能**: 將當週數據加入歷史基線
- **輸出**: `complete_historical_baseline.json`
- **執行時間**: < 10 秒
- **API 調用**: 0 次（使用現有數據）

## 🚀 使用方式

### 週期性自動化（GitHub Actions）
```bash
# 這個會自動執行，無需干預
# 主要執行: 週五美股收盤後 5 分鐘（自動適配夏令時）
# 備用執行: 週六早上 6:00 UTC
python etl_lite.py
```

### 手動更新歷史數據
```bash
# 當需要更新歷史趨勢圖時執行
python update_historical_data.py
```

## 📁 數據文件說明

### 前端消費的文件
- `weekly_stats.json` - 當週公司數據（主要數據源）
- `summary.json` - 數據摘要（更新時間、公司數量等）
- `complete_historical_baseline.json` - 歷史趨勢數據（圖表用）

### 配置文件
- `holdings.json` - 公司持倉配置

### 已棄用文件（歷史相容性）
- `historical_baseline.json` - 舊格式歷史數據
- `etl.py` - 原始 ETL 腳本（包含歷史數據處理）
- `incremental_etl.py` - 增量歷史數據腳本
- `convert_data.py` - 數據格式轉換工具

## ⚡ 性能優化成果

### 優化前（原始 ETL）
- 執行時間: 2-4 分鐘
- API 調用: 20+ 次
- 失敗率: 高（頻繁 429 錯誤）
- 處理內容: 當週 + 歷史數據
- 執行時間: 週日 23:59 UTC（與市場收盤時間不符）

### 優化後（輕量化 ETL）
- 執行時間: < 1 分鐘（包含數據等待機制）
- API 調用: ~10 次
- 失敗率: 低（智能後備策略 + 異常報告）
- 處理內容: 僅當週數據
- 執行時間: 美股收盤後 5 分鐘（自動適配夏令時）
- **新增功能**: 市場數據新鮮度檢查、異常報告系統

## 🔧 故障排除

### GitHub Actions 失敗
1. 檢查 API 速率限制（429 錯誤）
2. 確認 Git 權限設定
3. 查看 workflow 日誌

### 歷史數據缺失
```bash
# 手動更新歷史基線
python update_historical_data.py
```

### 數據格式問題
確認 `holdings.json` 格式正確：
```json
{
  "TICKER": {
    "company_name": "Company Name",
    "coin": "CRYPTO",
    "holding_qty": 123456,
    "coin_id": "coingecko-id"
  }
}
```

## 📈 監控與維護

### 定期檢查項目
- [ ] GitHub Actions 執行狀態
- [ ] 數據文件更新時間
- [ ] API 調用配額使用情況
- [ ] 前端顯示是否正常

### 月度維護
- [ ] 更新 `holdings.json` 中的持倉數量
- [ ] 檢查新的加密股票標的
- [ ] 更新硬編碼的加密貨幣供應量數據

## 🎯 最佳實踐

1. **不要在自動化流程中處理歷史數據**
2. **使用輕量化腳本進行週期性更新**
3. **分離歷史數據管理與即時數據更新**
4. **保持 API 調用頻率在合理範圍內**
5. **實施智能後備策略避免完全失敗**

---

*此策略確保系統穩定性，同時保持數據新鮮度和分析能力的平衡。*